import chisel3._
import chiseltest._
import org.scalatest.flatspec.AnyFlatSpec

class CacheControllerTest extends AnyFlatSpec with ChiselScalatestTester {
  "Controller" should "init" in {
    test(new CacheController) { dut =>
      dut.io.ready.expect(true.B)

    }
  }
  "Controller" should "miss" in {
    test(new CacheController){ dut =>
      dut.io.memAdd.poke(0.U)
      dut.io.validReq.poke(true.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.ready.expect(false.B)
      dut.io.cacheHit.expect(false.B)
    }
  }
  "Controller" should "be invalid" in {
    test(new CacheController) { dut =>
      dut.io.memAdd.poke(0.U)
      dut.io.DI.poke(42.U)
      dut.io.validReq.poke(true.B)
      dut.io.rw.poke(false.B)
      dut.clock.step()
      dut.io.validReq.poke(false.B)
      dut.io.memReady.poke(false.B)
      dut.io.ready.expect(false.B)
      dut.io.cacheHit.expect(false.B)
      dut.io.cacheValid.expect(false.B)
    }
  }
  "Controller" should "be valid" in {
    test(new CacheController) { dut =>
      dut.io.memAdd.poke(0.U)
      dut.io.DI.poke(42.U)
      dut.io.validReq.poke(true.B)
      dut.io.rw.poke(false.B)
      dut.io.memReady.poke(false.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.validReq.poke(false.B)
      dut.io.ready.expect(false.B)
      dut.io.cacheHit.expect(false.B)
      dut.io.cacheValid.expect(false.B)
      dut.io.memReady.poke(true.B)
      dut.io.writeIdx.expect(0.U)
      dut.clock.step()
      dut.io.stateAllocate.expect(true.B)
      dut.clock.step()
      dut.io.writeIdx.expect(1.U)
      dut.clock.step()
      dut.io.writeIdx.expect(2.U)
      dut.clock.step()
      dut.io.writeIdx.expect(3.U)
      dut.io.tagOut.expect(2048.U)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.writeIdx.expect(0.U)

      dut.io.tagOut.expect(2048.U)
      dut.io.readTag.expect(2048.U)
      dut.io.cacheValid.expect(true.B)
    }
  }
  "Controller" should "hit" in {
    test(new CacheController) { dut =>
      dut.io.memAdd.poke(0.U)
      dut.io.DI.poke(42.U)
      dut.io.validReq.poke(true.B)
      dut.io.rw.poke(false.B)
      dut.io.memReady.poke(false.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.validReq.poke(false.B)
      dut.io.ready.expect(false.B)
      dut.io.cacheHit.expect(false.B)
      dut.io.cacheValid.expect(false.B)
      dut.io.memReady.poke(true.B)
      dut.io.writeIdx.expect(0.U)
      dut.clock.step()
      dut.io.stateAllocate.expect(true.B)
      dut.clock.step()
      dut.io.writeIdx.expect(1.U)
      dut.clock.step()
      dut.io.writeIdx.expect(2.U)
      dut.clock.step()
      dut.io.writeIdx.expect(3.U)
      dut.io.tagOut.expect(2048.U)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.tagOut.expect(2048.U)
      dut.io.readTag.expect(2048.U)
      dut.io.cacheValid.expect(true.B)
      dut.io.cacheHit.expect(true.B)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.clock.step()
      dut.io.stateWriteT.expect(true.B)

    }
  }
  "Controller" should "write" in {
    test(new CacheController) { dut =>
      dut.io.memAdd.poke(0.U)
      dut.io.DI.poke(42.U)
      dut.io.validReq.poke(true.B)
      dut.io.rw.poke(false.B)
      dut.io.memReady.poke(false.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.validReq.poke(false.B)
      dut.io.ready.expect(false.B)
      dut.io.cacheHit.expect(false.B)
      dut.io.cacheValid.expect(false.B)
      dut.io.memReady.poke(true.B)
      dut.io.writeIdx.expect(0.U)
      dut.clock.step()
      dut.io.stateAllocate.expect(true.B)
      dut.clock.step()
      dut.io.writeIdx.expect(1.U)
      dut.clock.step()
      dut.io.writeIdx.expect(2.U)
      dut.clock.step()
      dut.io.writeIdx.expect(3.U)
      dut.io.tagOut.expect(2048.U)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.tagOut.expect(2048.U)
      dut.io.readTag.expect(2048.U)
      dut.io.cacheValid.expect(true.B)
      dut.io.cacheHit.expect(true.B)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.clock.step()
      dut.io.stateWriteT.expect(true.B)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.clock.step()
      dut.io.ready.expect(true.B)

    }
  }
  "Controller" should "read" in {
    test(new CacheController) { dut =>
      dut.io.memAdd.poke(0.U)
      dut.io.DI.poke(42.U)
      dut.io.validReq.poke(true.B)
      dut.io.rw.poke(false.B)
      dut.io.memReady.poke(false.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.validReq.poke(false.B)
      dut.io.ready.expect(false.B)
      dut.io.cacheHit.expect(false.B)
      dut.io.cacheValid.expect(false.B)
      dut.io.memReady.poke(true.B)
      dut.io.writeIdx.expect(0.U)
      dut.clock.step()
      dut.io.stateAllocate.expect(true.B)
      dut.io.cacheAdd.expect(0.U)
      dut.clock.step()
      dut.io.writeIdx.expect(1.U)
      dut.io.cacheAdd.expect(1.U)
      dut.clock.step()
      dut.io.writeIdx.expect(2.U)
      dut.io.cacheAdd.expect(2.U)
      dut.clock.step()
      dut.io.writeIdx.expect(3.U)
      dut.io.cacheAdd.expect(3.U)
      dut.io.tagOut.expect(2048.U)
      //dut.clock.step()
      //dut.io.cacheAdd.expect(3.U)
      //dut.io.stateWait.expect(true.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.tagOut.expect(2048.U)
      dut.io.readTag.expect(2048.U)
      dut.io.cacheValid.expect(true.B)
      dut.io.cacheHit.expect(true.B)

      //dut.clock.step()
      //dut.io.cacheAdd.expect(0.U)
      //dut.io.stateWait.expect(true.B)
      dut.clock.step()
      dut.io.stateWriteT.expect(true.B)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.clock.step()
      dut.io.ready.expect(true.B)

      dut.clock.step()
      dut.io.ready.expect(true.B)
      dut.io.rw.poke(true.B)
      dut.io.validReq.poke(true.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.cacheValid.expect(true.B)
      dut.io.cacheHit.expect(true.B)
      dut.clock.step()
      dut.io.ready.expect(true.B)
      dut.io.DO.expect(42.U)

    }
  }
  "Controller" should "read (other word in block)" in {
    test(new CacheController) { dut =>
      dut.io.memAdd.poke(0.U)
      dut.io.DI.poke(42.U)
      dut.io.validReq.poke(true.B)
      dut.io.rw.poke(false.B)
      dut.io.memReady.poke(false.B)

      dut.clock.step()

      dut.io.stateCompare.expect(true.B)

      dut.io.validReq.poke(false.B)
      dut.io.ready.expect(false.B)
      dut.io.cacheHit.expect(false.B)
      dut.io.cacheValid.expect(false.B)
      dut.io.memReady.poke(true.B)
      dut.io.writeIdx.expect(0.U)
      dut.clock.step()

      dut.io.stateAllocate.expect(true.B)
      dut.io.cacheAdd.expect(0.U)
      dut.io.cacheDI.expect(0.U)
      dut.clock.step()
      dut.io.writeIdx.expect(1.U)
      dut.io.cacheAdd.expect(1.U)
      dut.io.cacheDI.expect(0.U)
      dut.clock.step()
      dut.io.writeIdx.expect(2.U)
      dut.io.cacheAdd.expect(2.U)
      dut.io.cacheDI.expect(0.U)
      dut.clock.step()
      dut.io.writeIdx.expect(3.U)
      dut.io.cacheAdd.expect(3.U)
      dut.io.cacheDI.expect(0.U)
      dut.io.tagOut.expect(2048.U)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      //dut.io.writeIdx.expect(3.U)
      //dut.io.cacheAdd.expect(3.U)
      //dut.io.cacheDI.expect(0.U)
      dut.clock.step()

      dut.io.stateCompare.expect(true.B)
      dut.io.tagOut.expect(2048.U)
      dut.io.readTag.expect(2048.U)
      dut.io.cacheValid.expect(true.B)
      dut.io.cacheHit.expect(true.B)
      dut.io.cacheDO.expect(0.U)
      dut.io.cacheAdd.expect(0.U)
      dut.io.cacheDI.expect(42.U)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      //dut.io.cacheDO.expect(0.U)
      //dut.io.cacheAdd.expect(0.U)
      //dut.io.cacheDI.expect(42.U)
      dut.clock.step()
      dut.io.stateWriteT.expect(true.B)
      dut.io.cacheAdd.expect(0.U)
      //dut.io.cacheDO.expect(42.U)
      dut.io.memDI.expect(42.U)
      dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      //dut.io.cacheAdd.expect(0.U)
      //dut.io.cacheDO.expect(42.U)
      //dut.io.memDI.expect(42.U)

      dut.clock.step()
      dut.io.ready.expect(true.B)
      dut.io.cacheDO.expect(0.U)
      dut.io.DI.poke(2.U)
      dut.clock.step()
      dut.io.ready.expect(true.B)
      dut.io.rw.poke(false.B)
      dut.io.memAdd.poke("b1000".U)
      dut.io.validReq.poke(true.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.cacheValid.expect(true.B)
      dut.io.cacheHit.expect(true.B)
      dut.io.cacheAdd.expect(2.U)
      dut.io.cacheDI.expect(2.U)
      dut.io.cacheDO.expect(0.U)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      //dut.io.cacheAdd.expect(2.U)
      //dut.io.cacheDI.expect(2.U)
      dut.clock.step()
      dut.io.stateWriteT.expect(true.B)
      dut.io.memDI.expect(2.U)
      dut.io.cacheAdd.expect(2.U)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      //dut.io.cacheAdd.expect(2.U)
      //dut.io.cacheDO.expect(2.U)
      dut.clock.step()
      dut.io.ready.expect(true.B)
      dut.io.validReq.poke(true.B)
      dut.io.rw.poke(true.B)

      dut.clock.step()
      dut.io.validReq.poke(false.B)
      dut.io.stateCompare.expect(true.B)
      dut.io.cacheAdd.expect(2.U)
      dut.io.cacheEN.expect(true.B)
      dut.clock.step()
      dut.io.ready.expect(true.B)
      dut.io.DO.expect(2.U)
      dut.io.memAdd.poke("b0000".U)
      dut.io.validReq.poke(true.B)
      dut.clock.step()
      dut.io.validReq.poke(false.B)
      dut.io.stateCompare.expect(true.B)
      dut.io.cacheEN.expect(true.B)
      dut.io.cacheAdd.expect(0.U)
      dut.clock.step()
      dut.io.ready.expect(true.B)
      dut.io.cacheAdd.expect(0.U)
      dut.io.DO.expect(42.U)
      dut.io.memAdd.poke("b100".U)
      dut.io.validReq.poke(true.B)
      dut.clock.step()
      dut.io.validReq.poke(false.B)
      dut.io.stateCompare.expect(true.B)
      dut.io.cacheEN.expect(true.B)
      dut.io.cacheAdd.expect(1.U)
      dut.clock.step()
      dut.io.ready.expect(true.B)
      dut.io.cacheAdd.expect(0.U)
      dut.io.DO.expect(0.U)
    }
  }

  "Controller" should "be invalid (new block)" in {
    test(new CacheController) { dut =>
      dut.io.memAdd.poke(0.U)
      dut.io.DI.poke(42.U)
      dut.io.validReq.poke(true.B)
      dut.io.rw.poke(false.B)
      dut.io.memReady.poke(false.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.validReq.poke(false.B)
      dut.io.ready.expect(false.B)
      dut.io.cacheHit.expect(false.B)
      dut.io.cacheValid.expect(false.B)
      dut.io.memReady.poke(true.B)
      dut.io.writeIdx.expect(0.U)
      dut.clock.step()
      dut.io.stateAllocate.expect(true.B)
      dut.clock.step()
      dut.io.writeIdx.expect(1.U)
      dut.clock.step()
      dut.io.writeIdx.expect(2.U)
      dut.clock.step()
      dut.io.writeIdx.expect(3.U)
      dut.io.tagOut.expect(2048.U)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.tagOut.expect(2048.U)
      dut.io.readTag.expect(2048.U)
      dut.io.cacheValid.expect(true.B)
      dut.io.cacheHit.expect(true.B)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.clock.step()
      dut.io.stateWriteT.expect(true.B)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.clock.step()
      dut.io.ready.expect(true.B)

      dut.clock.step()
      dut.io.ready.expect(true.B)
      dut.io.rw.poke(true.B)
      dut.io.memAdd.poke("b10000".U)
      dut.io.validReq.poke(true.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.cacheValid.expect(false.B)
    }
  }

  "Controller" should "allocate" in {
    test(new CacheController) { dut =>
      dut.io.memAdd.poke(0.U)
      dut.io.DI.poke(42.U)
      dut.io.validReq.poke(true.B)
      dut.io.rw.poke(false.B)
      dut.io.memReady.poke(true.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.clock.step()
      dut.io.stateAllocate.expect(true.B)
      dut.clock.step(3)
      //dut.io.stateWait.expect(true.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.cacheHit.expect(true.B)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.io.cacheAdd.expect(0.U)
      dut.io.cacheDO.expect(0.U)
      dut.clock.step()
      dut.io.stateWriteT.expect(true.B)
      dut.io.extMemAdd.expect(0.U)
      dut.io.memDI.expect(42.U)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.io.extMemAdd.expect(0.U)
      dut.io.memDI.expect(42.U)
      dut.clock.step()
      dut.io.ready.expect(true.B)
      dut.io.DI.poke(21.U)
      dut.io.memAdd.poke("b100".U)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.io.cacheAdd.expect(1.U)
      dut.io.cacheDI.expect(21.U)
      dut.clock.step()
      dut.io.stateWriteT.expect((true.B))
      dut.io.extMemAdd.expect(1.U)
      dut.io.memDI.expect(21.U)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.clock.step()
      dut.io.ready.expect(true.B)

      dut.io.DI.poke(2.U)
      dut.io.memAdd.poke("h1000".U) // New memory, same index (should overwrite current index)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.extMemAdd.expect("h400".U)
      dut.clock.step()
      dut.io.stateAllocate.expect(true.B)
      dut.io.extMemAdd.expect("h401".U)
      dut.clock.step()
      dut.io.extMemAdd.expect("h402".U)
      dut.io.tagOut.expect("h1800".U)
      dut.clock.step(2)
      //dut.io.stateWait.expect(true.B)
      //dut.io.extMemAdd.expect("h400".U)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.extMemAdd.expect("h400".U)
      dut.io.readTag.expect("h1800".U)
      dut.io.cacheHit.expect(true.B)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.io.extMemAdd.expect("h400".U)
      dut.clock.step()
      dut.io.stateWriteT.expect(true.B)
      dut.io.extMemAdd.expect("h400".U)
      dut.io.memDI.expect(2.U)
      //dut.clock.step()
      //dut.io.stateWait.expect(true.B)
      dut.io.extMemAdd.expect("h400".U)
      dut.io.memDI.expect(2.U)
      dut.clock.step()
      dut.io.extMemAdd.expect("h400".U)
      dut.io.ready.expect(true.B)
      dut.io.rw.poke(true.B)
      dut.clock.step(2)
      dut.io.ready.expect(true.B)
      dut.io.extMemAdd.expect("h400".U)
      dut.io.DO.expect(2.U)

      dut.io.memAdd.poke(0.U)
      dut.io.validReq.poke(true.B)
      dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.clock.step()
      dut.io.stateAllocate.expect(true.B)
      dut.io.extMemAdd.expect(1.U)
      dut.io.memDO.expect(42.U)
      dut.io.cacheAdd.expect(0.U)
      dut.io.cacheDI.expect(42.U)
      dut.clock.step()
      dut.io.extMemAdd.expect(2.U)
      dut.io.memDO.expect(21.U)
      dut.io.cacheAdd.expect(1.U)
      dut.io.cacheDI.expect(21.U)
      dut.clock.step()
      dut.io.extMemAdd.expect(3.U)
      dut.io.memDO.expect(0.U)
      dut.io.cacheAdd.expect(2.U)
      dut.io.cacheDI.expect(0.U)
      dut.clock.step(2)
      //dut.io.stateWait.expect(true.B)
      //dut.clock.step()
      dut.io.stateCompare.expect(true.B)
      dut.io.cacheHit.expect(true.B)
      dut.io.cacheAdd.expect(0.U)
      dut.clock.step()
      dut.io.ready.expect(true.B)
      dut.io.DO.expect(42.U)
      dut.io.memAdd.poke("b100".U)
      dut.clock.step(2)
      dut.io.ready.expect(true.B)
      dut.io.DO.expect(21.U)
      dut.io.memAdd.poke("b1000".U)
      dut.clock.step(2)
      dut.io.ready.expect(true.B)
      dut.io.DO.expect(0.U)
      dut.io.memAdd.poke("h1000".U)
      dut.clock.step(7) // skip write wait 8->7
      dut.io.ready.expect(true.B)
      dut.io.DO.expect(2.U)
      dut.io.memAdd.poke("h1004".U)
      dut.clock.step(2)
      dut.io.ready.expect(true.B)
      dut.io.DO.expect(0.U)

    }
  }
}
